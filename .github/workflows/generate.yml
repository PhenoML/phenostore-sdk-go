name: Regenerate SDK

on:
  repository_dispatch:
    types: [spec-updated]
  workflow_dispatch: # manual trigger (uses committed api/openapi.yaml)

permissions:
  contents: write
  pull-requests: write

jobs:
  regenerate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-go@v6
        with:
          go-version-file: go.mod

      - name: Update spec from dispatch payload
        if: github.event_name == 'repository_dispatch'
        env:
          SPEC_B64: ${{ github.event.client_payload.spec_b64 }}
        run: |
          echo "$SPEC_B64" | base64 -d > api/openapi.yaml

      - name: Regenerate client
        run: go generate ./phenostore/

      - name: Verify compilation
        run: go build ./...

      - name: Run tests
        run: go test -race -count=1 -timeout 5m ./...

      - name: Create pull request
        if: github.event_name == 'repository_dispatch'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SPEC_SHA: ${{ github.event.client_payload.spec_sha }}
          PHENOSTORE_SHA: ${{ github.event.client_payload.phenostore_sha }}
          PR_TITLE: ${{ github.event.client_payload.pr_title }}
        run: |
          BRANCH="sdk-regen/${SPEC_SHA}"

          # Check if there are actual changes to commit
          if git diff --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH"
          git add -A

          if [[ -n "${PR_TITLE}" ]]; then
            COMMIT_TITLE="feat: regenerate SDK — ${PR_TITLE}"
          else
            COMMIT_TITLE="feat: regenerate SDK from spec ${SPEC_SHA}"
          fi

          git commit -m "${COMMIT_TITLE}"
          git push -u origin "$BRANCH"

          gh pr create \
            --base main \
            --head "$BRANCH" \
            --title "${COMMIT_TITLE}" \
            --body "Automated SDK regeneration.

          **Spec version:** \`${SPEC_SHA}\`
          **Phenostore commit:** \`${PHENOSTORE_SHA}\`

          > Adjust the PR title prefix before merging to control the version bump:
          > \`feat:\` → minor, \`fix:\` → patch, \`feat!:\` → major, \`chore:\` → no release."
