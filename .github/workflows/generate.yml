name: Regenerate SDK

on:
  repository_dispatch:
    types: [spec-updated]
  workflow_dispatch: # manual trigger (uses committed api/openapi.yaml)

permissions:
  contents: write
  pull-requests: write
  # id-token: write  # uncomment for AWS Bedrock or Google Vertex AI OIDC auth

jobs:
  regenerate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-go@v6
        with:
          go-version-file: go.mod

      # Commit the spec to a branch first so that if later steps fail,
      # the workflow can be retried via workflow_dispatch on this branch
      # without needing to re-dispatch from the upstream repo.
      - name: Commit spec from dispatch payload
        if: github.event_name == 'repository_dispatch'
        env:
          SPEC_B64: ${{ github.event.client_payload.spec_b64 }}
          SPEC_SHA: ${{ github.event.client_payload.spec_sha }}
        run: |
          echo "$SPEC_B64" | base64 -d > api/openapi.yaml
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git checkout -b "sdk-regen/${SPEC_SHA}"
          git add api/openapi.yaml
          git commit -m "chore: update OpenAPI spec to ${SPEC_SHA}"
          git push -u origin "sdk-regen/${SPEC_SHA}"

      - name: Regenerate client
        run: go generate ./phenostore/

      - name: Check if build passes after regeneration
        id: try-build
        continue-on-error: true
        run: go build ./...

      # If the spec introduced breaking type changes, use Claude Code to
      # adapt the hand-written wrapper (client.go, errors.go, examples/).
      - name: Adapt wrapper to generated changes
        if: steps.try-build.outcome == 'failure'
        uses: anthropics/claude-code-base-action@beta
        with:
          prompt_file: .github/prompts/fix-generated-client.md
          allowed_tools: "View,Edit,Write,GlobTool,GrepTool,Bash(go:*)"
          max_turns: "15"
          # Auth option 1: Anthropic API key (simplest — store as repo secret)
          anthropic_api_key: ${{ secrets.CLAUDE_API_KEY }}
          # Auth option 2: AWS Bedrock (no user-specific key, uses OIDC)
          #   Requires: aws-actions/configure-aws-credentials step + id-token permission
          # use_bedrock: "true"
          # model: "anthropic.claude-4-0-sonnet-20250805-v1:0"
          # Auth option 3: Google Vertex AI (no user-specific key, uses OIDC)
          #   Requires: google-github-actions/auth step + id-token permission
          # use_vertex: "true"
          # model: "claude-4-0-sonnet@20250805"

      - name: Verify compilation
        run: go build ./...

      - name: Run tests
        run: go test -race -count=1 -timeout 5m ./...

      - name: Generate commit message
        if: github.event_name == 'repository_dispatch'
        uses: anthropics/claude-code-base-action@beta
        with:
          prompt_file: .github/prompts/generate-commit-message.md
          allowed_tools: "View,GlobTool,GrepTool,Bash(git:*),Write"
          max_turns: "5"
          anthropic_api_key: ${{ secrets.CLAUDE_API_KEY }}

      - name: Create pull request
        if: github.event_name == 'repository_dispatch'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SPEC_SHA: ${{ github.event.client_payload.spec_sha }}
          PHENOSTORE_SHA: ${{ github.event.client_payload.phenostore_sha }}
          PR_TITLE: ${{ github.event.client_payload.pr_title }}
        run: |
          BRANCH="sdk-regen/${SPEC_SHA}"

          # Check if there are generated/wrapper changes to commit
          if git diff --quiet; then
            echo "No changes beyond the spec update"
            exit 0
          fi

          git add -A

          if [[ -f .commit-message ]]; then
            COMMIT_TITLE=$(head -1 .commit-message)
          elif [[ -n "${PR_TITLE}" ]]; then
            COMMIT_TITLE="feat: regenerate SDK — ${PR_TITLE}"
          else
            COMMIT_TITLE="feat: regenerate SDK from spec ${SPEC_SHA}"
          fi

          git commit -m "${COMMIT_TITLE}"
          git push

          gh pr create \
            --base main \
            --head "$BRANCH" \
            --title "${COMMIT_TITLE}" \
            --body "Automated SDK regeneration.

          **Spec version:** \`${SPEC_SHA}\`
          **Phenostore commit:** \`${PHENOSTORE_SHA}\`

          > Adjust the PR title prefix before merging to control the version bump:
          > \`feat:\` → minor, \`fix:\` → patch, \`feat!:\` → major, \`chore:\` → no release."
